@page "/Recipients/Manage"

@using No_Kill_Inventory.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext Context

@attribute [Authorize]

<PageTitle>Manage Recipients</PageTitle>

<AuthorizeView>
    <Authorized>
        <!-- Search Section -->
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.h5">Search Recipients</MudText>

            <MudTextField @bind-Value="searchTerm" Placeholder="Enter recipient name or phone number..." Immediate="true" Class="mb-2" />
            
            @if (!filteredRecipients.Any() && !string.IsNullOrWhiteSpace(searchTerm))
            {
                <MudText>No recipients found.</MudText>
            }

        </MudPaper>

        <!-- Recipient Info Update Section -->
        @foreach (var recipient in pagedRecipients)
        {
            <MudPaper Class="pa-2 mb-2">
                <MudText Typo="Typo.subtitle2">@recipient.FirstName @recipient.LastName</MudText>
                <MudText Typo="Typo.body2">@recipient.PhoneNumber</MudText>

                <div class="d-flex flex-wrap gap-2 mt-1">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => SelectRecipient(recipient))">
                        Select Recipient
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@(() => ShowAppointmentDate(recipient))">
                        Show Last Appointment
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="@(() => ToggleFormDataView(recipient.Id))">
                        Show Google Form Data
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@(() => AddForm(recipient))">
                        Add Form
                    </MudButton>
                </div>
                
                @if (activeFormRecipientId == recipient.Id)
                {
                    <MudPaper Class="pa-4 mt-2" Elevation="2">
                        <MudForm OnValidSubmit="SubmitNewForm">
                            <MudSelect T="FormType" Label="Form Type" @bind-Value="formType" Required="true">
                                @foreach (FormType type in Enum.GetValues<FormType>())
                                {
                                    <MudSelectItem Value="@type">@type.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                            
                            

                            <MudDatePicker Label="Date" @bind-Date="formDate" Required="true" />
                            
                            @if (formType != FormType.SpayNeuter)
                            {
                                <MudDatePicker Label="Expiration Date" @bind-Date="formExpDate" Required="true"/>
                                <MudTextField @bind-Value="formComment" Label="Comments" Variant="Variant.Text"></MudTextField>
                            }
                            else
                            {
                                <MudTextField @bind-Value="formComment" Label="Pet Name" Variant="Variant.Text"></MudTextField>
                            }
                            
                            <MudButton Type="Submit" Variant="Variant.Filled" Color="Color.Tertiary" Class="mt-2" OnClick="@(() => SubmitNewForm())">
                                Submit Form
                            </MudButton>
                        </MudForm>
                        
                        @if (activeFormsForRecipient.Any())
                        {
                            <MudPaper Class="pa-2 mt-2" Elevation="1">
                                <MudText Typo="Typo.subtitle2">Active Forms for @recipient.FirstName:</MudText>
                                <MudTable Items="activeFormsForRecipient" Hover="true" Dense="true">
                                    <HeaderContent>
                                        <MudTh>Type</MudTh>
                                        <MudTh>Date</MudTh>
                                        <MudTh>Expires</MudTh>
                                        <MudTh>Comments</MudTh>
                                    </HeaderContent>
                                    <RowTemplate Context="form">
                                        <MudTd>@form.FormType</MudTd>
                                        <MudTd>@form.Date</MudTd>
                                        <MudTd>@form.ExpDate</MudTd>
                                        <MudTd>@form.Comment</MudTd>
                                        <MudTd>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Color="Color.Error"
                                                           OnClick="@(async () => await DeleteForm(form.Id))"
                                                           Title="Delete this form" />
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </MudPaper>
                        }
                        
                    </MudPaper>
                }

                @if (recipientToShowDate?.Id == recipient.Id)
                {
                    <MudText Typo="Typo.caption" Class="mt-1">
                        Last Appointment Date: @(string.IsNullOrWhiteSpace(recipient.LastAppointmentDate) ? "N/A" : recipient.LastAppointmentDate)
                    </MudText>
                }

                @if (selectedRecipient?.Id == recipient.Id)
                {
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.h6">Update Info for @recipient.FirstName @recipient.LastName</MudText>

                    <MudTextField T="string"
                                  Label="Items Receiving"
                                  @bind-Value="selectedRecipient.ItemsReceiving"
                                  Placeholder="Enter items or information" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SubmitRecipientInfo"
                               Class="mt-2">
                        Submit
                    </MudButton>
                }
        
                @if (expandedRecipientId == recipient.Id)
                {
                    <MudPaper Class="mt-2 p-3" Elevation="2">
                        <MudTable Items="expandedRecipientRequests" Hover="true" Dense="true">
                            <RowTemplate Context="request">
                                <MudTd ColSpan="5">
                                    <MudText><b>Form Submitted:</b> @request.Timestamp</MudText>
                                    <MudText><b>First Name:</b> @request.FirstName</MudText>
                                    <MudText><b>Last Name:</b> @request.LastName</MudText>
                                    <MudText><b>Phone:</b> @request.ContactPhoneNumber</MudText>
                                    <MudText><b>Email:</b> @request.EmailAddress</MudText>
                                    <MudText><b>Physical Address:</b> @request.PhysicalAddress</MudText>

                                    <MudDivider Class="my-2" />
                                    
                                    <MudText><b>Adults in Household:</b> @request.AdultsInHousehold</MudText>
                                    <MudText><b>Names of Adults:</b> @request.NamesOfAdults</MudText>
                                    <MudText><b>Children in Household:</b> @request.ChildrenInHousehold</MudText>
                                    <MudText><b>Authorized Pickup Persons:</b> @request.AuthorizedPickupPersons</MudText>
                                    <MudText><b>Household Income Sources:</b> @request.HouseholdIncomeSources</MudText>
                                    <MudText><b>Fostering Organization:</b> @request.FosteringOrganization</MudText>
                                    <MudText><b>Breeding Animals:</b> @request.BreedingAnimals</MudText>
                                    <MudText><b>Spay/Neuter Acknowledgment:</b> @request.SpayNeuterAcknowledgment</MudText>

                                    <MudDivider Class="my-2" />
                                    
                                    <MudText Typo="Typo.subtitle2">Dogs:</MudText>
                                    <table style="width: 100%; margin-bottom: 1rem;">
                                        <thead>
                                        <tr>
                                            <th style="text-align: left;">Dog Name</th>
                                            <th style="text-align: left;">Breed</th>
                                            <th style="text-align: left;">Sex</th>
                                            <th style="text-align: left;">Weight</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        @if (!string.IsNullOrWhiteSpace(request.Dog1Name))
                                        {
                                            <tr>
                                                <td>@request.Dog1Name</td>
                                                <td>@request.Dog1Breed</td>
                                                <td>@request.Dog1Sex</td>
                                                <td>@request.Dog1Weight</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(request.Dog2Name))
                                        {
                                            <tr>
                                                <td>@request.Dog2Name</td>
                                                <td>@request.Dog2Breed</td>
                                                <td>@request.Dog2Sex</td>
                                                <td>@request.Dog2Weight</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(request.Dog3Name))
                                        {
                                            <tr>
                                                <td>@request.Dog3Name</td>
                                                <td>@request.Dog3Breed</td>
                                                <td>@request.Dog3Sex</td>
                                                <td>@request.Dog3Weight</td>
                                            </tr>
                                        }
                                        </tbody>
                                    </table>

                                    <MudText Typo="Typo.subtitle2">Cats:</MudText>
                                    <table style="width: 100%; margin-bottom: 1rem;">
                                        <thead>
                                        <tr>
                                            <th style="text-align: left;">Cat Name</th>
                                            <th style="text-align: left;">Sex</th>
                                            <th style="text-align: left;">Residence</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        @if (!string.IsNullOrWhiteSpace(request.Cat1Name))
                                        {
                                            <tr>
                                                <td>@request.Cat1Name</td>
                                                <td>@request.Cat1Sex</td>
                                                <td>@request.Cat1Residence</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(request.Cat2Name))
                                        {
                                            <tr>
                                                <td>@request.Cat2Name</td>
                                                <td>@request.Cat2Sex</td>
                                                <td>@request.Cat2Residence</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(request.Cat3Name))
                                        {
                                            <tr>
                                                <td>@request.Cat3Name</td>
                                                <td>@request.Cat3Sex</td>
                                                <td>@request.Cat3Residence</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(request.Cat4Name))
                                        {
                                            <tr>
                                                <td>@request.Cat4Name</td>
                                                <td>@request.Cat4Sex</td>
                                                <td>@request.Cat4Residence</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(request.Cat5Name))
                                        {
                                            <tr>
                                                <td>@request.Cat5Name</td>
                                                <td>@request.Cat5Sex</td>
                                                <td>@request.Cat5Residence</td>
                                            </tr>
                                        }
                                        </tbody>
                                    </table>
                                    <MudDivider Class="my-2" />

                                    <MudText><b>Other Animals:</b> @request.OtherAnimals</MudText>
                                    <MudText><b>Preferred Notification Method:</b> @request.PreferredNotificationMethod</MudText>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                }
                
                
            </MudPaper>
}

        @if (totalPages > 1)
{
    <div class="d-flex justify-content-center mt-2">
        <MudButton Disabled="@(currentPage == 1)" OnClick="PrevPage">Previous</MudButton>
        <MudText Class="mx-2">Page @currentPage of @totalPages</MudText>
        <MudButton Disabled="@(currentPage == totalPages)" OnClick="NextPage">Next</MudButton>
    </div>
}

    </Authorized>
    
</AuthorizeView>

@code {
    private int currentPage = 1;
    private int pageSize = 15;
    private string[] errors = { };
    private PetType[] petTypes = [ PetType.Dog, PetType.Cat, PetType.Other ];
    private Recipient? recipientToShowDate;
    
    private int? activeFormRecipientId = null; // tracks expanded form under a recipient
    private Form newForm = new();
    private DateTime? formDate = DateTime.Today;
    private DateTime? formExpDate = DateTime.Today.AddYears(1);
    private string formComment = "";
    private FormType formType;
    private List<Form> activeFormsForRecipient = new();


private void ShowAppointmentDate(Recipient recipient)
{
    recipientToShowDate = recipient;
}

    private Recipient? selectedRecipient;  // Track the selected recipient

    private string _searchTerm = "";
    private string searchTerm
    {
        get => _searchTerm;
        set
        {
            if (_searchTerm != value)
            {
                _searchTerm = value;
                currentPage = 1;
            }
        }
    }

    private List<Recipient> allRecipients = new();
    private IEnumerable<Recipient> filteredRecipients =>
        allRecipients
            .Where(r =>
                $"{r.FirstName} {r.LastName}".Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (r.PhoneNumber != null && r.PhoneNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            )
            .ToList();

    protected override async Task OnInitializedAsync()
    {
        allRecipients = await Context.Recipients.ToListAsync();
    }

    private void SelectRecipient(Recipient recipient)
    {
        selectedRecipient = recipient;  // Set the selected recipient
    }

    private async Task SubmitRecipientInfo()
    {
        try
        {
            // Update the selected recipient with the new ItemsReceiving info
            Context.Recipients.Update(selectedRecipient);
            await Context.SaveChangesAsync();

            // Optionally, reset the form or do other actions
            selectedRecipient = null;  // Reset selected recipient after submission
        }
        catch (Exception ex)
        {
            errors = new[] { "Error saving recipient info: " + ex.Message };
        }
    }

    private IEnumerable<Recipient> pagedRecipients => 
    filteredRecipients
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize);

    private int totalPages => (int)Math.Ceiling((double)filteredRecipients.Count() / pageSize);

    private void NextPage()
{
    if (currentPage < totalPages)
        currentPage++;
}

private void PrevPage()
{
    if (currentPage > 1)
        currentPage--;
}

private int? expandedRecipientId = null;
private List<PetFoodRequest> expandedRecipientRequests = new();

private async Task ToggleFormDataView(int recipientId)
{
    if (expandedRecipientId == recipientId)
    {
        expandedRecipientId = null;
        expandedRecipientRequests.Clear();
    }
    else
    {
        expandedRecipientId = recipientId;
        expandedRecipientRequests = await Context.PetFoodRequests
            .Where(r => r.Id == recipientId)
            .OrderByDescending(r => r.Timestamp)
            .ToListAsync();
    }
}

private void AddForm(Recipient recipient)
{
    if (activeFormRecipientId == recipient.Id)
    {
        activeFormRecipientId = null;
        newForm = new();
        activeFormsForRecipient.Clear();
    }
    else
    {
        activeFormRecipientId = recipient.Id;
        newForm = new Form
        {
            RecipientId = recipient.Id,
            FormType = FormType.Application
        };
        formDate = DateTime.Today;
        formExpDate = DateTime.Today.AddYears(1);

        // Load active forms for this recipient
        activeFormsForRecipient = Context.Forms
            .Where(f => f.RecipientId == recipient.Id && f.isActive)
            .OrderByDescending(f => f.Date)
            .ToList();
    }
}

private async Task SubmitNewForm()
{
    if (formDate.HasValue)
    {
        var recipientId = newForm.RecipientId;

        if (formType != FormType.SpayNeuter)
        {
            var existingActiveForm = await Context.Forms
                .Where(f => f.RecipientId == recipientId &&
                            f.FormType == formType &&
                            f.isActive)
                .FirstOrDefaultAsync();

            if (existingActiveForm != null)
            {
                existingActiveForm.isActive = false;
                Context.Forms.Update(existingActiveForm);
            }
        }

        newForm.FormType = formType;
        newForm.Date = formDate.Value.ToString("yyyy-MM-dd");
        newForm.ExpDate = formExpDate.Value.ToString("yyyy-MM-dd");
        newForm.Comment = formComment;
        newForm.isActive = true;

        Context.Forms.Add(newForm);
        await Context.SaveChangesAsync();

        // Refresh active forms
        activeFormsForRecipient = await Context.Forms
            .Where(f => f.RecipientId == recipientId && f.isActive)
            .OrderBy(f => f.FormType == FormType.Application ? 0
                : f.FormType == FormType.ProofOfIncome ? 1
                : 2)
            .ThenByDescending(f => f.Date)
            .ToListAsync();

        // Reset fields but retain RecipientId
        newForm = new Form { RecipientId = recipientId };
        formComment = "";
        formDate = DateTime.Today;
        formExpDate = DateTime.Today.AddYears(1);
    }
}

private async Task DeleteForm(int formId)
{
    var form = await Context.Forms.FindAsync(formId);
    if (form != null)
    {
        Context.Forms.Remove(form);
        await Context.SaveChangesAsync();

        // Refresh the list after deletion
        if (form.RecipientId == activeFormRecipientId)
        {
            activeFormsForRecipient = await Context.Forms
                .Where(f => f.RecipientId == form.RecipientId && f.isActive)
                .OrderBy(f => f.FormType == FormType.Application ? 0
                    : f.FormType == FormType.ProofOfIncome ? 1
                    : 2)
                .ThenByDescending(f => f.Date)
                .ToListAsync();
        }
    }
}


}
